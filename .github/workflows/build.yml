name: Build ICE-Guard (Matrix: x64 + ARM64, Auto Release)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:

  # ---------------------------------------------------------
  # WINDOWS BUILD (x64 + ARM64)
  # ---------------------------------------------------------
  build-windows:
    name: Windows (${{ matrix.arch }})
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: ${{ matrix.arch }}

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: powershell

      - name: Build EXE + Installer via PowerShell
        run: |
          ./build-windows.ps1 -Arch "${{ matrix.arch }}" -InnoSetupPath "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        shell: powershell

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: ICE-Guard-Windows-${{ matrix.arch }}
          path: dist/ICE-Guard-${{ matrix.arch }}.exe

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: ICE-Guard-Installer-${{ matrix.arch }}
          path: |
            Output/ICE-Guard_Setup_${{ matrix.arch }}.exe
            ICE-Guard_Setup_${{ matrix.arch }}.exe

  # ---------------------------------------------------------
  # LINUX BUILD (x64 + ARM64)
  # ---------------------------------------------------------
  build-linux:
    name: Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable ARM64 cross-build
        if: matrix.arch == 'arm64'
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt update

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y dpkg-dev
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build ice-guard binary
        run: |
          pyinstaller --onefile blackice/main.py --name ice-guard-${{ matrix.arch }}

      - name: Prepare DEB structure
        run: |
          mkdir -p iceguard_deb/DEBIAN
          mkdir -p iceguard_deb/usr/local/bin
          cp dist/ice-guard-${{ matrix.arch }} iceguard_deb/usr/local/bin/ice-guard
          chmod 755 iceguard_deb/usr/local/bin/ice-guard

          cat <<EOF > iceguard_deb/DEBIAN/control
          Package: ice-guard
          Version: 1.0
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Christoffer
          Description: ICE-Guard network intrusion monitor
           ICE-Guard is a simplified, educational intrusion detection tool inspired by BlackICE.
          EOF

      - name: Build DEB package
        run: |
          dpkg-deb --build iceguard_deb
          mv iceguard_deb.deb ice-guard_1.0_${{ matrix.arch }}.deb

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: ICE-Guard-DEB-${{ matrix.arch }}
          path: ice-guard_1.0_${{ matrix.arch }}.deb

  # ---------------------------------------------------------
  # CREATE GITHUB RELEASE
  # ---------------------------------------------------------
  release:
    name: Publish Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
